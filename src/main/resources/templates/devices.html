<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSRF Meta Tags (Render only if CSRF is enabled) -->
    <meta th:if="${_csrf != null}" name="_csrf" th:content="${_csrf.token}" />
    <meta th:if="${_csrf != null}" name="_csrf_header" th:content="${_csrf.headerName}" />
    <title>SmartTracking - I Miei Dispositivi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/smarttracking-design-system.css}">
    <style>
        body {
            background: var(--gray-50);
        }

        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: var(--spacing-lg);
            margin-top: var(--spacing-xl);
        }

        .device-card {
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            transition: all var(--transition-normal);
        }

        .device-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-lg);
            transform: translateY(-4px);
        }

        .device-card h3 {
            color: var(--primary);
            font-size: 1.25rem;
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .device-info {
            margin: var(--spacing-sm) 0;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .device-info i {
            color: var(--gray-400);
            width: 20px;
        }

        .device-info strong {
            color: var(--gray-900);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-virgin {
            background: var(--warning-light);
            color: var(--warning-dark);
        }

        .status-provisioned {
            background: var(--info-light);
            color: var(--info-dark);
        }

        .status-active {
            background: var(--success-light);
            color: var(--success-dark);
        }

        .status-decommissioned {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .action-bar {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
            flex-wrap: wrap;
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--gray-600);
        }

        .empty-state i {
            font-size: 5rem;
            color: var(--gray-300);
            margin-bottom: var(--spacing-lg);
        }

        .empty-state h3 {
            color: var(--gray-900);
            margin-bottom: var(--spacing-md);
        }
    </style>
</head>

<body>
    <!-- NAVBAR MODERNA -->
    <nav class="navbar">
        <div class="navbar-brand">
            <i class="fas fa-map-marked-alt"></i>
            SmartTracking
        </div>
        <div class="nav-links">
            <a th:href="@{/dashboard}"><i class="fas fa-home"></i> Dashboard</a>
            <a th:href="@{/devices}" style="background:var(--primary); color:white;"><i class="fas fa-microchip"></i>
                Dispositivi</a>
            <a th:href="@{/shipments}"><i class="fas fa-shipping-fast"></i> Spedizioni</a>
            <a th:href="@{/profile}"><i class="fas fa-user"></i> Profilo</a>

            <!-- LOGOUT FORM (FIX SPRING SECURITY) -->
            <form th:action="@{/logout}" method="post" style="margin: 0;">
                <button type="submit" class="btn-logout" style="border:none; cursor:pointer;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </form>
        </div>
    </nav>

    <!-- CONTAINER -->
    <div class="container">
        <h1><i class="fas fa-microchip"></i> I Miei Dispositivi</h1>

        <!-- SUCCESS MESSAGE -->
        <div th:if="${successMessage}" class="alert alert-success animate-slide-in">
            <i class="fas fa-check-circle"></i>
            <span th:text="${successMessage}"></span>
        </div>

        <!-- ERROR MESSAGE -->
        <div th:if="${errorMessage}" class="alert alert-error animate-shake">
            <i class="fas fa-exclamation-triangle"></i>
            <span th:text="${errorMessage}"></span>
        </div>

        <!-- ACTION BAR -->
        <div class="action-bar">
            <!-- Provisioning with Qrcode -->
            <a th:href="@{/devices/provision}" class="btn btn-primary" style="background-color: #2563eb;">
                <i class="fas fa-qrcode"></i> Provisioning with Qrcode
            </a>
            <!-- Simulate Device provisioning request -->
            <button onclick="simulateRequest()" class="btn btn-warning" style="cursor: pointer;">
                <i class="fas fa-magic"></i> Simulate Device provisioning request
            </button>
        </div>

        <!-- EMPTY STATE -->
        <div th:if="${devices.isEmpty()}" class="empty-state card animate-fade-in">
            <i class="fas fa-mobile-alt"></i>
            <h3>Nessun dispositivo trovato</h3>
            <p>Inizia generando un codice QR per associare un nuovo dispositivo!</p>
            <br>
        </div>

        <!-- DEVICES GRID -->
        <div th:unless="${devices.isEmpty()}" class="devices-grid">
            <div th:each="device : ${devices}" class="device-card animate-fade-in">
                <h3>
                    <i class="fas fa-microchip"></i>
                    Dispositivo
                </h3>

                <div class="device-info">
                    <i class="fas fa-fingerprint"></i>
                    <strong>MAC:</strong>
                    <span th:text="${device.macAddress}">00:00:00:00:00:00</span>
                </div>

                <div class="device-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Stato:</strong>
                    <span class="status-badge" th:classappend="${'status-' + #strings.toLowerCase(device.status)}"
                        th:text="${device.status}">ACTIVE</span>
                </div>

                <div class="device-info" th:if="${device.currentShipmentId != null}">
                    <i class="fas fa-shipping-fast"></i>
                    <strong>Spedizione:</strong>
                    <a th:href="@{'/shipments/' + ${device.currentShipmentId}}"
                        style="color: var(--primary); text-decoration: none;">
                        Vedi dettagli
                    </a>
                </div>

                <div class="device-info" th:if="${device.lastCommunication != null}">
                    <i class="fas fa-clock"></i>
                    <strong>Ultima comunicazione:</strong>
                    <span th:text="${#temporals.format(device.lastCommunication, 'dd/MM/yyyy HH:mm')}"></span>
                </div>

                <div class="device-info" th:if="${device.batteryLevel != null}">
                    <i class="fas fa-battery-three-quarters"></i>
                    <strong>Batteria:</strong>
                    <span th:text="${device.batteryLevel + '%'}"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Anime.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <!-- SmartTracking Custom Animations -->
    <script th:src="@{/js/smarttracking-animations.js}"></script>
    <script>
        async function simulateRequest() {
            if (!confirm("Vuoi simulare una richiesta di provisioning automatica? Un nuovo dispositivo 'Virgin' verr√† creato e associato a te immediatamente.")) return;

            try {
                const initRes = await fetch('/api/device/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initCertificate: 'INIT_SECRET_2024' })
                });

                if (!initRes.ok) throw new Error("Device initialization failed");
                const initData = await initRes.json();
                const mac = initData.macAddress;

                const formData = new URLSearchParams();
                formData.append('macAddress', mac);

                const headers = { 'Content-Type': 'application/x-www-form-urlencoded' };

                // Add CSRF only if present
                const csrfMeta = document.querySelector("meta[name='_csrf']");
                const csrfHeaderMeta = document.querySelector("meta[name='_csrf_header']");
                if (csrfMeta && csrfHeaderMeta) {
                    headers[csrfHeaderMeta.getAttribute("content")] = csrfMeta.getAttribute("content");
                }

                const assocRes = await fetch('/devices/associate', {
                    method: 'POST',
                    headers: headers,
                    body: formData
                });

                if (assocRes.ok) {
                    alert('Dispositivo ' + mac + ' associato con successo!');
                    window.location.reload();
                } else {
                    throw new Error("Association failed");
                }

            } catch (e) {
                console.error(e);
                alert("Errore durante la simulazione: " + e.message);
            }
        }
    </script>
</body>

</html>